<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blog Feed</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container my-4">
  <h1 class="mb-4">üåç Public Blog</h1>

  <div id="postsContainer"></div>

  <script>
    const api = 'http://localhost:3000/api'

    async function loadPosts() {
      const res = await fetch(`${api}/posts`)
      const posts = await res.json()

      const postsHTML = await Promise.all(posts.map(async post => {
        const commentsRes = await fetch(`${api}/comments/${post._id}`)
        const comments = await commentsRes.json()

        const commentsHTML = comments.map(c => `
          <div class="border-start ps-2 mb-2">
            <strong>${c.username || 'Anon'}:</strong> ${c.text}
          </div>
        `).join('')

        return `
          <div class="card mb-4">
            <div class="card-body">
              <h3>${post.title}</h3>
              <p>${post.body}</p>
              <small class="text-muted">by ${post.author || 'Anon'} on ${new Date(post.createdAt).toLocaleDateString()}</small>
              <hr/>
              <h5>Comments</h5>
              ${commentsHTML || '<p>No comments yet.</p>'}
              <form onsubmit="return postComment('${post._id}', this)">
                <input name="username" class="form-control my-1" placeholder="Your name" />
                <textarea name="text" class="form-control my-1" placeholder="Write a comment..." required></textarea>
                <button class="btn btn-sm btn-secondary">Post Comment</button>
              </form>
            </div>
          </div>
        `
      }))

      document.getElementById('postsContainer').innerHTML = postsHTML.join('')
    }

    async function postComment(postId, form) {
      const data = {
        username: form.username.value,
        text: form.text.value
      }

      await fetch(`${api}/comments/${postId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })

      form.text.value = ''
      loadPosts()
      return false
    }

    loadPosts()
  </script>
</body>
</html>
